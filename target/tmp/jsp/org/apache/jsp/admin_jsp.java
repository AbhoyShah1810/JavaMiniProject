/*
 * Generated by the Jasper component of Apache Tomcat
 * Version: jetty/9.4.53.v20231009
 * Generated at: 2025-12-11 16:26:22 UTC
 * Note: The last modified time of this file was set to
 *       the last modified time of the source file after
 *       generation to assist with modification tracking.
 */
package org.apache.jsp;

import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.jsp.*;
import com.logiclab.db.DBConnection;
import java.sql.*;

public final class admin_jsp extends org.apache.jasper.runtime.HttpJspBase
    implements org.apache.jasper.runtime.JspSourceDependent,
                 org.apache.jasper.runtime.JspSourceImports {

  private static final javax.servlet.jsp.JspFactory _jspxFactory =
          javax.servlet.jsp.JspFactory.getDefaultFactory();

  private static java.util.Map<java.lang.String,java.lang.Long> _jspx_dependants;

  private static final java.util.Set<java.lang.String> _jspx_imports_packages;

  private static final java.util.Set<java.lang.String> _jspx_imports_classes;

  static {
    _jspx_imports_packages = new java.util.HashSet<>();
    _jspx_imports_packages.add("java.sql");
    _jspx_imports_packages.add("javax.servlet");
    _jspx_imports_packages.add("javax.servlet.http");
    _jspx_imports_packages.add("javax.servlet.jsp");
    _jspx_imports_classes = new java.util.HashSet<>();
    _jspx_imports_classes.add("com.logiclab.db.DBConnection");
  }

  private volatile javax.el.ExpressionFactory _el_expressionfactory;
  private volatile org.apache.tomcat.InstanceManager _jsp_instancemanager;

  public java.util.Map<java.lang.String,java.lang.Long> getDependants() {
    return _jspx_dependants;
  }

  public java.util.Set<java.lang.String> getPackageImports() {
    return _jspx_imports_packages;
  }

  public java.util.Set<java.lang.String> getClassImports() {
    return _jspx_imports_classes;
  }

  public javax.el.ExpressionFactory _jsp_getExpressionFactory() {
    if (_el_expressionfactory == null) {
      synchronized (this) {
        if (_el_expressionfactory == null) {
          _el_expressionfactory = _jspxFactory.getJspApplicationContext(getServletConfig().getServletContext()).getExpressionFactory();
        }
      }
    }
    return _el_expressionfactory;
  }

  public org.apache.tomcat.InstanceManager _jsp_getInstanceManager() {
    if (_jsp_instancemanager == null) {
      synchronized (this) {
        if (_jsp_instancemanager == null) {
          _jsp_instancemanager = org.apache.jasper.runtime.InstanceManagerFactory.getInstanceManager(getServletConfig());
        }
      }
    }
    return _jsp_instancemanager;
  }

  public void _jspInit() {
  }

  public void _jspDestroy() {
  }

  public void _jspService(final javax.servlet.http.HttpServletRequest request, final javax.servlet.http.HttpServletResponse response)
      throws java.io.IOException, javax.servlet.ServletException {

    final java.lang.String _jspx_method = request.getMethod();
    if (!"GET".equals(_jspx_method) && !"POST".equals(_jspx_method) && !"HEAD".equals(_jspx_method) && !javax.servlet.DispatcherType.ERROR.equals(request.getDispatcherType())) {
      response.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED, "JSPs only permit GET, POST or HEAD. Jasper also permits OPTIONS");
      return;
    }

    final javax.servlet.jsp.PageContext pageContext;
    javax.servlet.http.HttpSession session = null;
    final javax.servlet.ServletContext application;
    final javax.servlet.ServletConfig config;
    javax.servlet.jsp.JspWriter out = null;
    final java.lang.Object page = this;
    javax.servlet.jsp.JspWriter _jspx_out = null;
    javax.servlet.jsp.PageContext _jspx_page_context = null;


    try {
      response.setContentType("text/html; charset=UTF-8");
      pageContext = _jspxFactory.getPageContext(this, request, response,
      			null, true, 8192, true);
      _jspx_page_context = pageContext;
      application = pageContext.getServletContext();
      config = pageContext.getServletConfig();
      session = pageContext.getSession();
      out = pageContext.getOut();
      _jspx_out = out;

      out.write('\n');
      out.write('\n');
      out.write('\n');

    // Security: Check if user is logged in and is ADMIN
    if (session.getAttribute("user") == null) {
        response.sendRedirect("login.jsp");
        return;
    }
    
    String role = (String) session.getAttribute("role");
    if (!"ADMIN".equals(role)) {
        response.sendRedirect("game.jsp");
        return;
    }
    
    String username = (String) session.getAttribute("user");
    String message = "";
    String messageType = ""; // "success" or "error"
    
    Connection con = null;
    PreparedStatement psList = null;
    ResultSet rsList = null;
    
    // User Management Resources
    PreparedStatement psUserList = null;
    ResultSet rsUserList = null;
    
    try {
        con = DBConnection.getConnection();
        
        // --- USER MANAGEMENT LOGIC ---
        
        // Handle USER UPDATE
        if (request.getParameter("update_user") != null) {
            String uId = request.getParameter("user_id");
            String pass = request.getParameter("password");
            String uRole = request.getParameter("role");
            String uLevel = request.getParameter("current_level_id");
            
            if (uId != null) {
                try {
                    PreparedStatement ps = con.prepareStatement("UPDATE users SET password=?, role=?, current_level_id=? WHERE user_id=?");
                    ps.setString(1, pass);
                    ps.setString(2, uRole);
                    ps.setInt(3, Integer.parseInt(uLevel));
                    ps.setInt(4, Integer.parseInt(uId));
                    int rows = ps.executeUpdate();
                    ps.close();
                    if (rows > 0) {
                        message = "User updated successfully!";
                        messageType = "success";
                    } else {
                        message = "Error: User not found!";
                        messageType = "error";
                    }
                } catch (Exception e) {
                    message = "Error updating user: " + e.getMessage();
                    messageType = "error";
                }
            }
        }
        
        // Handle USER DELETE
        if (request.getParameter("delete_user") != null) {
            String uId = request.getParameter("user_id");
             if (uId != null) {
                try {
                    PreparedStatement ps = con.prepareStatement("DELETE FROM users WHERE user_id=?");
                    ps.setInt(1, Integer.parseInt(uId));
                    int rows = ps.executeUpdate();
                    ps.close();
                    if (rows > 0) {
                        message = "User deleted successfully!";
                        messageType = "success";
                    } else {
                        message = "Error: User not found!";
                        messageType = "error";
                    }
                } catch (Exception e) {
                    message = "Error deleting user: " + e.getMessage();
                    messageType = "error";
                }
            }
        }
        
        // Fetch User for Editing
        String editUserId = request.getParameter("edit_user_id");
        if (request.getParameter("user_id") != null && request.getParameter("edit_user") != null) {
            editUserId = request.getParameter("user_id");
        }
        
        String editUsername = "";
        String editPassword = "";
        String editRole = "STUDENT";
        int editCurrentLevel = 1;
        boolean isUserEditMode = false;
        
        if (editUserId != null && !editUserId.isEmpty()) {
            try {
                PreparedStatement ps = con.prepareStatement("SELECT * FROM users WHERE user_id=?");
                ps.setInt(1, Integer.parseInt(editUserId));
                ResultSet rs = ps.executeQuery();
                if (rs.next()) {
                    isUserEditMode = true;
                    editUsername = rs.getString("username");
                    editPassword = rs.getString("password");
                    editRole = rs.getString("role");
                    editCurrentLevel = rs.getInt("current_level_id");
                }
                rs.close();
                ps.close();
            } catch (Exception e) {
                // Ignore
            }
        }
        
        // --- LEVEL MANAGEMENT LOGIC (Existing) ---
        
        // Handle CREATE operation
        if (request.getParameter("create") != null) {
            String levelId = request.getParameter("level_id");
            String description = request.getParameter("description");
            String gridLayout = request.getParameter("grid_layout");
            String solutionKey = request.getParameter("solution_key");
            String gridSize = request.getParameter("grid_size");
            
            if (levelId != null && !levelId.trim().isEmpty()) {
                try {
                    PreparedStatement ps = con.prepareStatement("INSERT INTO levels (level_id, description, grid_layout, solution_key, grid_size) VALUES (?, ?, ?, ?, ?)");
                    ps.setInt(1, Integer.parseInt(levelId));
                    ps.setString(2, description != null ? description : "");
                    ps.setString(3, gridLayout != null ? gridLayout : "");
                    ps.setString(4, solutionKey != null ? solutionKey : "");
                    ps.setInt(5, gridSize != null && !gridSize.isEmpty() ? Integer.parseInt(gridSize) : 5);
                    ps.executeUpdate();
                    ps.close();
                    message = "Level created successfully!";
                    messageType = "success";
                } catch (SQLException e) {
                    if (e.getErrorCode() == 1062) { // Duplicate entry
                        message = "Error: Level ID already exists!";
                    } else {
                        message = "Error creating level: " + e.getMessage();
                    }
                    messageType = "error";
                } catch (NumberFormatException e) {
                    message = "Error: Invalid number format!";
                    messageType = "error";
                }
            }
        }
        
        // Handle UPDATE operation
        if (request.getParameter("update") != null) {
            String levelId = request.getParameter("level_id");
            String description = request.getParameter("description");
            String gridLayout = request.getParameter("grid_layout");
            String solutionKey = request.getParameter("solution_key");
            String gridSize = request.getParameter("grid_size");
            
            if (levelId != null && !levelId.trim().isEmpty()) {
                try {
                    PreparedStatement ps = con.prepareStatement("UPDATE levels SET description=?, grid_layout=?, solution_key=?, grid_size=? WHERE level_id=?");
                    ps.setString(1, description != null ? description : "");
                    ps.setString(2, gridLayout != null ? gridLayout : "");
                    ps.setString(3, solutionKey != null ? solutionKey : "");
                    ps.setInt(4, gridSize != null && !gridSize.isEmpty() ? Integer.parseInt(gridSize) : 5);
                    ps.setInt(5, Integer.parseInt(levelId));
                    int rows = ps.executeUpdate();
                    ps.close();
                    if (rows > 0) {
                        message = "Level updated successfully!";
                        messageType = "success";
                    } else {
                        message = "Error: Level not found!";
                        messageType = "error";
                    }
                } catch (SQLException e) {
                    message = "Error updating level: " + e.getMessage();
                    messageType = "error";
                } catch (NumberFormatException e) {
                    message = "Error: Invalid number format!";
                    messageType = "error";
                }
            }
        }
        
        // Handle DELETE operation
        if (request.getParameter("delete") != null) {
            String levelId = request.getParameter("level_id");
            if (levelId != null && !levelId.trim().isEmpty()) {
                try {
                    PreparedStatement ps = con.prepareStatement("DELETE FROM levels WHERE level_id=?");
                    ps.setInt(1, Integer.parseInt(levelId));
                    int rows = ps.executeUpdate();
                    ps.close();
                    if (rows > 0) {
                        message = "Level deleted successfully!";
                        messageType = "success";
                    } else {
                        message = "Error: Level not found!";
                        messageType = "error";
                    }
                } catch (SQLException e) {
                    message = "Error deleting level: " + e.getMessage();
                    messageType = "error";
                } catch (NumberFormatException e) {
                    message = "Error: Invalid number format!";
                    messageType = "error";
                }
            }
        }
        
        // Handle READ operation - Fetch level for editing
        String editLevelId = request.getParameter("edit");
        // FIX: If edit triggered by button (POST), the value is in 'level_id'
        if (request.getParameter("level_id") != null && editLevelId != null) {
            editLevelId = request.getParameter("level_id");
        }
        String editDescription = "";
        String editGridLayout = "";
        String editSolutionKey = "";
        int editGridSize = 5;
        boolean isEditMode = false;
        
        if (editLevelId != null && !editLevelId.trim().isEmpty()) {
            try {
                PreparedStatement ps = con.prepareStatement("SELECT * FROM levels WHERE level_id=?");
                ps.setInt(1, Integer.parseInt(editLevelId));
                ResultSet rs = ps.executeQuery();
                if (rs.next()) {
                    isEditMode = true;
                    editDescription = rs.getString("description") != null ? rs.getString("description") : "";
                    editGridLayout = rs.getString("grid_layout") != null ? rs.getString("grid_layout") : "";
                    editSolutionKey = rs.getString("solution_key") != null ? rs.getString("solution_key") : "";
                    editGridSize = rs.getInt("grid_size");
                }
                rs.close();
                ps.close();
            } catch (Exception e) {
                // Ignore
            }
        }
        
        // Fetch all levels for display
        psList = con.prepareStatement("SELECT * FROM levels ORDER BY level_id");
        rsList = psList.executeQuery();

      out.write("\n");
      out.write("<!DOCTYPE html>\n");
      out.write("<html>\n");
      out.write("<head>\n");
      out.write("    <meta charset=\"UTF-8\">\n");
      out.write("    <title>LogicLab - Admin Panel</title>\n");
      out.write("    <link rel=\"stylesheet\" href=\"assets/css/style.css\">\n");
      out.write("    <style>\n");
      out.write("        .admin-container {\n");
      out.write("            max-width: 1200px;\n");
      out.write("            margin: 20px auto;\n");
      out.write("            padding: 20px;\n");
      out.write("            background-color: #C6C6C6;\n");
      out.write("            border: 4px solid #373737;\n");
      out.write("            box-shadow: 8px 8px 0px rgba(0,0,0,0.2);\n");
      out.write("        }\n");
      out.write("        .admin-header {\n");
      out.write("            display: flex;\n");
      out.write("            justify-content: space-between;\n");
      out.write("            align-items: center;\n");
      out.write("            margin-bottom: 20px;\n");
      out.write("        }\n");
      out.write("        .admin-header h2 {\n");
      out.write("            margin: 0;\n");
      out.write("            color: #373737;\n");
      out.write("        }\n");
      out.write("        .admin-header a {\n");
      out.write("            color: #57381C;\n");
      out.write("            text-decoration: none;\n");
      out.write("        }\n");
      out.write("        .message {\n");
      out.write("            padding: 10px;\n");
      out.write("            margin-bottom: 20px;\n");
      out.write("            border: 2px solid;\n");
      out.write("            text-align: center;\n");
      out.write("        }\n");
      out.write("        .message.success {\n");
      out.write("            color: #00AA00;\n");
      out.write("            background-color: rgba(200, 255, 200, 0.5);\n");
      out.write("            border-color: #00AA00;\n");
      out.write("        }\n");
      out.write("        .message.error {\n");
      out.write("            color: #AA0000;\n");
      out.write("            background-color: rgba(255, 200, 200, 0.5);\n");
      out.write("            border-color: #AA0000;\n");
      out.write("        }\n");
      out.write("        .form-section, .list-section {\n");
      out.write("            margin-bottom: 30px;\n");
      out.write("            padding: 20px;\n");
      out.write("            background-color: #F4E4BC;\n");
      out.write("            border: 2px solid #57381C;\n");
      out.write("        }\n");
      out.write("        .form-group {\n");
      out.write("            margin-bottom: 15px;\n");
      out.write("        }\n");
      out.write("        .form-group label {\n");
      out.write("            display: block;\n");
      out.write("            color: #3e2723;\n");
      out.write("            margin-bottom: 5px;\n");
      out.write("            font-size: 18px;\n");
      out.write("        }\n");
      out.write("        .form-group input, .form-group textarea {\n");
      out.write("            width: 100%;\n");
      out.write("            padding: 8px;\n");
      out.write("            font-family: 'VT323', monospace;\n");
      out.write("            font-size: 18px;\n");
      out.write("            border: 2px solid #57381C;\n");
      out.write("            background: rgba(255, 255, 255, 0.9);\n");
      out.write("            box-sizing: border-box;\n");
      out.write("        }\n");
      out.write("        .form-group textarea {\n");
      out.write("            height: 80px;\n");
      out.write("            resize: vertical;\n");
      out.write("        }\n");
      out.write("        .button-group {\n");
      out.write("            display: flex;\n");
      out.write("            gap: 10px;\n");
      out.write("        }\n");
      out.write("        .button-group button {\n");
      out.write("            flex: 1;\n");
      out.write("        }\n");
      out.write("        table {\n");
      out.write("            width: 100%;\n");
      out.write("            border-collapse: collapse;\n");
      out.write("            background-color: rgba(255, 255, 255, 0.9);\n");
      out.write("        }\n");
      out.write("        table th, table td {\n");
      out.write("            padding: 10px;\n");
      out.write("            border: 1px solid #57381C;\n");
      out.write("            text-align: left;\n");
      out.write("        }\n");
      out.write("        table th {\n");
      out.write("            background-color: #787878;\n");
      out.write("            color: #FFF;\n");
      out.write("        }\n");
      out.write("        .action-buttons {\n");
      out.write("            display: flex;\n");
      out.write("            gap: 5px;\n");
      out.write("        }\n");
      out.write("        .action-buttons form {\n");
      out.write("            display: inline;\n");
      out.write("        }\n");
      out.write("        .btn-small {\n");
      out.write("            padding: 5px 10px;\n");
      out.write("            font-size: 14px;\n");
      out.write("        }\n");
      out.write("    </style>\n");
      out.write("</head>\n");
      out.write("<body>\n");
      out.write("    <div class=\"admin-container\">\n");
      out.write("        <div class=\"admin-header\">\n");
      out.write("            <h2>Admin Panel - Level Manager</h2>\n");
      out.write("            <div>\n");
      out.write("                <a href=\"game.jsp\">[Play Game]</a> | \n");
      out.write("                <a href=\"logout.jsp\">[Logout]</a>\n");
      out.write("            </div>\n");
      out.write("        </div>\n");
      out.write("        \n");
      out.write("        ");
 if (!message.isEmpty()) { 
      out.write("\n");
      out.write("            <div class=\"message ");
      out.print( messageType );
      out.write("\"><strong>");
      out.print( message );
      out.write("</strong></div>\n");
      out.write("        ");
 } 
      out.write("\n");
      out.write("        \n");
      out.write("        <!-- CREATE/UPDATE Form -->\n");
      out.write("        <div class=\"form-section\">\n");
      out.write("            <h3>");
      out.print( isEditMode ? "Edit Level" : "Create New Level" );
      out.write("</h3>\n");
      out.write("            <form method=\"POST\">\n");
      out.write("                <div class=\"form-group\">\n");
      out.write("                    <label for=\"level_id\">Level ID:</label>\n");
      out.write("                    <input type=\"number\" id=\"level_id\" name=\"level_id\" value=\"");
      out.print( isEditMode ? editLevelId : "" );
      out.write("\" required ");
      out.print( isEditMode ? "readonly" : "" );
      out.write(">\n");
      out.write("                </div>\n");
      out.write("                \n");
      out.write("                <div class=\"form-group\">\n");
      out.write("                    <label for=\"description\">Description:</label>\n");
      out.write("                    <input type=\"text\" id=\"description\" name=\"description\" value=\"");
      out.print( editDescription );
      out.write("\" required>\n");
      out.write("                </div>\n");
      out.write("                \n");
      out.write("                <div class=\"form-group\">\n");
      out.write("                    <label for=\"grid_layout\">Grid Layout (format: \"row,col,type;row,col,type\"):</label>\n");
      out.write("                    <textarea id=\"grid_layout\" name=\"grid_layout\" required>");
      out.print( editGridLayout );
      out.write("</textarea>\n");
      out.write("                    <small style=\"color: #616161;\">Example: 0,0,START; 2,2,GOAL; 1,1,WALL</small>\n");
      out.write("                </div>\n");
      out.write("                \n");
      out.write("                <div class=\"form-group\">\n");
      out.write("                    <label for=\"solution_key\">Solution Key (exact code to win):</label>\n");
      out.write("                    <textarea id=\"solution_key\" name=\"solution_key\" required>");
      out.print( editSolutionKey );
      out.write("</textarea>\n");
      out.write("                    <small style=\"color: #616161;\">Example: moveRight(2);moveDown(2);</small>\n");
      out.write("                </div>\n");
      out.write("                \n");
      out.write("                <div class=\"form-group\">\n");
      out.write("                    <label for=\"grid_size\">Grid Size:</label>\n");
      out.write("                    <input type=\"number\" id=\"grid_size\" name=\"grid_size\" value=\"");
      out.print( editGridSize );
      out.write("\" min=\"3\" max=\"10\" required>\n");
      out.write("                </div>\n");
      out.write("                \n");
      out.write("                <div class=\"button-group\">\n");
      out.write("                    ");
 if (isEditMode) { 
      out.write("\n");
      out.write("                        <button type=\"submit\" name=\"update\">Update Level</button>\n");
      out.write("                        <a href=\"admin.jsp\" style=\"flex: 1; text-align: center; padding: 10px; background-color: #787878; color: #FFF; border: 2px solid #000; text-decoration: none; display: inline-block;\">Cancel</a>\n");
      out.write("                    ");
 } else { 
      out.write("\n");
      out.write("                        <button type=\"submit\" name=\"create\">Create Level</button>\n");
      out.write("                    ");
 } 
      out.write("\n");
      out.write("                </div>\n");
      out.write("            </form>\n");
      out.write("        </div>\n");
      out.write("        \n");
      out.write("        <!-- READ - List all levels -->\n");
      out.write("        <div class=\"list-section\">\n");
      out.write("            <h3>Existing Levels</h3>\n");
      out.write("            <table>\n");
      out.write("                <thead>\n");
      out.write("                    <tr>\n");
      out.write("                        <th>Level ID</th>\n");
      out.write("                        <th>Description</th>\n");
      out.write("                        <th>Grid Size</th>\n");
      out.write("                        <th>Actions</th>\n");
      out.write("                    </tr>\n");
      out.write("                </thead>\n");
      out.write("                <tbody>\n");
      out.write("                    ");
 
                        boolean hasLevels = false;
                        while (rsList.next()) {
                            hasLevels = true;
                            int levelId = rsList.getInt("level_id");
                            String desc = rsList.getString("description");
                            int gSize = rsList.getInt("grid_size");
                    
      out.write("\n");
      out.write("                    <tr>\n");
      out.write("                        <td>");
      out.print( levelId );
      out.write("</td>\n");
      out.write("                        <td>");
      out.print( desc != null ? desc : "" );
      out.write("</td>\n");
      out.write("                        <td>");
      out.print( gSize );
      out.write('x');
      out.print( gSize );
      out.write("</td>\n");
      out.write("                        <td>\n");
      out.write("                            <div class=\"action-buttons\">\n");
      out.write("                                <form method=\"POST\" style=\"display: inline;\">\n");
      out.write("                                    <input type=\"hidden\" name=\"level_id\" value=\"");
      out.print( levelId );
      out.write("\">\n");
      out.write("                                    <button type=\"submit\" name=\"edit\" class=\"btn-small\">Edit</button>\n");
      out.write("                                </form>\n");
      out.write("                                <form method=\"POST\" style=\"display: inline;\" onsubmit=\"return confirm('Are you sure you want to delete level ");
      out.print( levelId );
      out.write("?');\">\n");
      out.write("                                    <input type=\"hidden\" name=\"level_id\" value=\"");
      out.print( levelId );
      out.write("\">\n");
      out.write("                                    <button type=\"submit\" name=\"delete\" class=\"btn-small\" style=\"background-color: #AA0000;\">Delete</button>\n");
      out.write("                                </form>\n");
      out.write("                            </div>\n");
      out.write("                        </td>\n");
      out.write("                    </tr>\n");
      out.write("                    ");
 
                        }
                        rsList.close();
                        psList.close();
                        if (!hasLevels) {
                    
      out.write("\n");
      out.write("                    <tr>\n");
      out.write("                        <td colspan=\"4\" style=\"text-align: center; color: #616161;\">No levels found. Create one above!</td>\n");
      out.write("                    </tr>\n");
      out.write("                    ");
 } 
      out.write("\n");
      out.write("                </tbody>\n");
      out.write("            </table>\n");
      out.write("        </div>\n");
      out.write("        <!-- USER MANAGER SECTION -->\n");
      out.write("        <hr style=\"border: 4px solid #373737; margin: 40px 0;\">\n");
      out.write("        \n");
      out.write("        <!-- User Editor Form -->\n");
      out.write("        <div class=\"form-section\" style=\"background-color: #E6E6FA;\">\n");
      out.write("            <h3>");
      out.print( isUserEditMode ? "Edit User: " + editUsername : "Manage Users" );
      out.write("</h3>\n");
      out.write("            ");
 if (isUserEditMode) { 
      out.write("\n");
      out.write("            <form method=\"POST\">\n");
      out.write("                <input type=\"hidden\" name=\"user_id\" value=\"");
      out.print( editUserId );
      out.write("\">\n");
      out.write("                \n");
      out.write("                <div class=\"form-group\">\n");
      out.write("                    <label>Username:</label>\n");
      out.write("                    <input type=\"text\" value=\"");
      out.print( editUsername );
      out.write("\" disabled style=\"background-color: #ddd;\">\n");
      out.write("                </div>\n");
      out.write("                \n");
      out.write("                <div class=\"form-group\">\n");
      out.write("                    <label for=\"password\">Password:</label>\n");
      out.write("                    <input type=\"text\" id=\"password\" name=\"password\" value=\"");
      out.print( editPassword );
      out.write("\" required>\n");
      out.write("                </div>\n");
      out.write("                \n");
      out.write("                <div class=\"form-group\">\n");
      out.write("                    <label for=\"role\">Role:</label>\n");
      out.write("                    <select id=\"role\" name=\"role\" style=\"width: 100%; padding: 8px; font-family: 'VT323'; font-size: 18px; border: 2px solid #57381C;\">\n");
      out.write("                        <option value=\"STUDENT\" ");
      out.print( "STUDENT".equals(editRole) ? "selected" : "" );
      out.write(">STUDENT</option>\n");
      out.write("                        <option value=\"ADMIN\" ");
      out.print( "ADMIN".equals(editRole) ? "selected" : "" );
      out.write(">ADMIN</option>\n");
      out.write("                    </select>\n");
      out.write("                </div>\n");
      out.write("                \n");
      out.write("                <div class=\"form-group\">\n");
      out.write("                    <label for=\"current_level_id\">Current Level:</label>\n");
      out.write("                    <input type=\"number\" id=\"current_level_id\" name=\"current_level_id\" value=\"");
      out.print( editCurrentLevel );
      out.write("\" required>\n");
      out.write("                </div>\n");
      out.write("                \n");
      out.write("                <div class=\"button-group\">\n");
      out.write("                    <button type=\"submit\" name=\"update_user\">Update User</button>\n");
      out.write("                    <a href=\"admin.jsp\" style=\"flex: 1; text-align: center; padding: 10px; background-color: #787878; color: #FFF; border: 2px solid #000; text-decoration: none; display: inline-block;\">Cancel</a>\n");
      out.write("                </div>\n");
      out.write("            </form>\n");
      out.write("            ");
 } else { 
      out.write("\n");
      out.write("                <p>Select a user from the list below to edit.</p>\n");
      out.write("            ");
 } 
      out.write("\n");
      out.write("        </div>\n");
      out.write("        \n");
      out.write("        <!-- User List -->\n");
      out.write("        <div class=\"list-section\">\n");
      out.write("            <h3>All Users</h3>\n");
      out.write("            <table>\n");
      out.write("                <thead>\n");
      out.write("                    <tr>\n");
      out.write("                        <th>ID</th>\n");
      out.write("                        <th>Username</th>\n");
      out.write("                        <th>Role</th>\n");
      out.write("                        <th>Level</th>\n");
      out.write("                        <th>Actions</th>\n");
      out.write("                    </tr>\n");
      out.write("                </thead>\n");
      out.write("                <tbody>\n");
      out.write("                    ");
 
                        psUserList = con.prepareStatement("SELECT * FROM users ORDER BY user_id");
                        rsUserList = psUserList.executeQuery();
                        boolean hasUsers = false;
                        while (rsUserList.next()) {
                            hasUsers = true;
                            int uId = rsUserList.getInt("user_id");
                            String uName = rsUserList.getString("username");
                            String uRole = rsUserList.getString("role");
                            int uLvl = rsUserList.getInt("current_level_id");
                    
      out.write("\n");
      out.write("                    <tr>\n");
      out.write("                        <td>");
      out.print( uId );
      out.write("</td>\n");
      out.write("                        <td>");
      out.print( uName );
      out.write("</td>\n");
      out.write("                        <td>");
      out.print( uRole );
      out.write("</td>\n");
      out.write("                        <td>");
      out.print( uLvl );
      out.write("</td>\n");
      out.write("                        <td>\n");
      out.write("                            <div class=\"action-buttons\">\n");
      out.write("                                <form method=\"POST\" style=\"display: inline;\">\n");
      out.write("                                    <input type=\"hidden\" name=\"user_id\" value=\"");
      out.print( uId );
      out.write("\">\n");
      out.write("                                    <button type=\"submit\" name=\"edit_user\" class=\"btn-small\">Edit</button>\n");
      out.write("                                </form>\n");
      out.write("                                ");
 if (!"admin".equals(uName)) { // Prevent deleting main admin 
      out.write("\n");
      out.write("                                <form method=\"POST\" style=\"display: inline;\" onsubmit=\"return confirm('Are you sure you want to delete user ");
      out.print( uName );
      out.write("?');\">\n");
      out.write("                                    <input type=\"hidden\" name=\"user_id\" value=\"");
      out.print( uId );
      out.write("\">\n");
      out.write("                                    <button type=\"submit\" name=\"delete_user\" class=\"btn-small\" style=\"background-color: #AA0000;\">Delete</button>\n");
      out.write("                                </form>\n");
      out.write("                                ");
 } 
      out.write("\n");
      out.write("                            </div>\n");
      out.write("                        </td>\n");
      out.write("                    </tr>\n");
      out.write("                    ");
 
                        }
                        rsUserList.close();
                        psUserList.close();
                    
      out.write("\n");
      out.write("                </tbody>\n");
      out.write("            </table>\n");
      out.write("        </div>\n");
      out.write("    </div>\n");
      out.write("</body>\n");
      out.write("</html>\n");

    } catch (SQLException e) {
        out.println("<div class='message error'>Database Error: " + e.getMessage() + "</div>");
    } finally {
        // Close all resources
        try {
            if (rsList != null) rsList.close();
            if (psList != null) psList.close();
            if (rsUserList != null) rsUserList.close();
            if (psUserList != null) psUserList.close();
            if (con != null) con.close();
        } catch (SQLException e) {
            // Ignore
        }
    }

      out.write('\n');
      out.write('\n');
    } catch (java.lang.Throwable t) {
      if (!(t instanceof javax.servlet.jsp.SkipPageException)){
        out = _jspx_out;
        if (out != null && out.getBufferSize() != 0)
          try {
            if (response.isCommitted()) {
              out.flush();
            } else {
              out.clearBuffer();
            }
          } catch (java.io.IOException e) {}
        if (_jspx_page_context != null) _jspx_page_context.handlePageException(t);
        else throw new ServletException(t);
      }
    } finally {
      _jspxFactory.releasePageContext(_jspx_page_context);
    }
  }
}
